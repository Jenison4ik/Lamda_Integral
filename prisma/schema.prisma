// =======================
// Datasource & Generator
// =======================

datasource db {
  provider = "sqlite"
}

generator client {
  provider = "prisma-client-js"
}

// =======================
// Models
// =======================

model User {
  id          Int           @id @default(autoincrement())
  telegramId  BigInt        @unique
  username    String?
  lastSeen    DateTime?
  createdAt   DateTime      @default(now())

  sessions    QuizSession[]

  @@map("users")
}

model QuizSession {
  id              Int              @id @default(autoincrement())
  userId          Int
  difficulty      String
  totalQuestions  Int
  correctAnswers  Int              @default(0)
  score           Int              @default(0)

  startedAt       DateTime         @default(now())
  finishedAt      DateTime?

  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  answers         SessionAnswer[]

  @@map("quiz_sessions")
}

model Question {
  id            Int              @id @default(autoincrement())
  difficulty    String           // "easy", "medium", "hard"
  text          String           // Текст вопроса (интеграл)
  createdAt     DateTime         @default(now())

  answerOptions AnswerOption[]

  @@map("questions")
}

model AnswerOption {
  id          Int              @id @default(autoincrement())
  questionId  Int
  text        String           // Текст варианта ответа
  isCorrect   Boolean          @default(false)

  question    Question         @relation(fields: [questionId], references: [id], onDelete: Cascade)
  chosenIn     SessionAnswer[]

  @@map("answer_options")
}

model SessionAnswer {
  id              Int          @id @default(autoincrement())
  sessionId       Int
  questionId      Int          // Для уникальности и быстрых запросов
  chosenOptionId  Int          // ID выбранного варианта ответа
  isCorrect       Boolean
  answeredAt      DateTime     @default(now())

  session         QuizSession  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  chosenOption    AnswerOption @relation(fields: [chosenOptionId], references: [id], onDelete: Cascade)
  // Вопрос можно получить через chosenOption.question, но questionId нужен для:
  // 1. Уникальности ответа на вопрос в сессии [sessionId, questionId]
  // 2. Быстрых запросов без JOIN
  // 3. Валидации (проверка, что chosenOption принадлежит questionId)

  @@unique([sessionId, questionId])
  @@map("session_answers")
}
